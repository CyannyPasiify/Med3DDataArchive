# ESO-2025.10.31 pCR Analysis Process Tutorial

## Steps

### 1️⃣Download ESO-2025.10.31 wrapped data archive from [this link (Baidu Drive)](https://pan.baidu.com/s/12vgxqKR-QhsBbdMN-6WooA)

This is a private data archive. You may email the maintainer for password.

Place the `archive` into an empty `root_dir`, e.g., `root_dir=/path/to/ESO-2025.10.31 `.

### 2️⃣Scan ESO-2025.10.31 dataset folder and gather sample pairs: Run routine 01

```sh
python 01_gather_id_samples.py --root_dir root_dir/grouped --manifest_file root_dir/grouped/dataset_manifest.xlsx --output_dir root_dir/pCR_analysis
```

Routine 01 first loads the dataset manifest file `grouped/dataset_manifest.xlsx`. It then groups samples by `site` and `pid`, and creates a new directory structure that consolidates relevant information and copies files for valid pre- and post-therapy sample pairs. Sample directories in `output_dir` are named in the format `{site}/{site}_{pid}`. Within each sample directory, the following files are provided:

- `{site}_{pid}_info.yaml`: A file recording the corresponding metadata.
- `{site}_{pid}_(pre|post)_volume.nii.gz`: The image file for the pre-therapy and post-therapy phases.
- `{site}_{pid}_(pre|post)_mask.nii.gz`: The mask file for the pre-therapy and post-therapy phases.

After processing, the directory structure is as follows:

```sh
root_dir
- pCR_analysis
  - SYTH
    - SYTH_189003440
      - SYTH_189003440_info.yaml
      - SYTH_189003440_pre_volume.nii.gz
      - SYTH_189003440_pre_mask.nii.gz
      - SYTH_189003440_post_volume.nii.gz
      - SYTH_189003440_post_mask.nii.gz
  - TJ
  - XY
```

### 3️⃣Resample volume-mask pairs: Run routine 02

```sh
python 02_resample_samples.py --root_dir root_dir/pCR_analysis --respacing 1.0 1.0 1.0 --thresh -140.0 1000.0
```

Routine 02 resamples the images (using linear interpolation) and masks (using nearest neighbor interpolation) to a standardized voxel spacing of `[1.0, 1.0, 1.0]`. For the resampled masks, an additional threshold filtering step is applied to remove foreground voxels outside the specified intensity range `[-140.0, 1000.0]` — these out-of-range voxels are relabeled as `0` (background). The processed files are saved in the same sample directory with the naming format `{site}_{pid}_(pre|post)_std_resampled_(volume|mask).nii.gz`.

After processing, the directory structure is as follows:

```sh
root_dir
- pCR_analysis
  - SYTH
    - SYTH_189003440
      - SYTH_189003440_info.yaml
      - SYTH_189003440_pre_volume.nii.gz
      - SYTH_189003440_pre_std_resampled_volume.nii.gz
      - SYTH_189003440_pre_mask.nii.gz
      - SYTH_189003440_pre_std_resampled_mask.nii.gz
      - SYTH_189003440_post_volume.nii.gz
      - SYTH_189003440_post_std_resampled_volume.nii.gz
      - SYTH_189003440_post_mask.nii.gz
      - SYTH_189003440_post_std_resampled_mask.nii.gz
  - TJ
  - XY
```

### 4️⃣Extract peritumor ROIs from the tumor ROI mask files: Run routine 03

```sh
03_extract_peritumor.py --root_dir root_dir/pCR_analysis --peri_expand_range 3.0 5.0 7.0 --mask_type std_resampled --volume_type std_resampled --valid_value_range -140.0 3000.0 --small_thresh 10
```

Routine 03 extracts peritumor regions from pre- and post-therapy masks by expanding the foreground boundaries by a specified distance and subtracting the original foreground region. Additionally, it filters these regions based on intensity values and removes small connected regions.

The detailed process is as follows:

1. Crop the foreground bounding box, then perform hole filling on the tumor ROI using morphological operations to form a new NoHole-ROI.
2. Construct an ellipsoidal structural element according to the specified `peri_expand_range` (e.g., 3.0 mm), then apply dilation to the NoHole-ROI to form an Expanded-ROI.
3. Apply a threshold filtering step to remove foreground voxels outside the specified intensity range `[-140.0, 3000.0]` — these out-of-range voxels are relabeled as `0` (background), thereby forming a Suppressed-ROI.
4. Retain the largest connected component in the Suppressed-ROI, then subtract the foreground region of the NoHole-ROI from the Suppressed-ROI.
5. Set a small region area threshold of 10 voxels, then eliminate all small connected regions below this threshold.

The resulting mask is saved in the sample directory with the naming format `{site}_{pid}_(pre|post)_peritumor_{peri_expand_range:0.1f}mm_std_resampled_mask.nii.gz`.

After processing, the directory structure is as follows:

```sh
root_dir
- pCR_analysis
  - SYTH
    - SYTH_189003440
      - SYTH_189003440_info.yaml
      - SYTH_189003440_pre_volume.nii.gz
      - SYTH_189003440_pre_std_resampled_volume.nii.gz
      - SYTH_189003440_pre_mask.nii.gz
      - SYTH_189003440_pre_std_resampled_mask.nii.gz
      - SYTH_189003440_pre_peritumor_3.0mm_std_resampled_mask.nii.gz
      - SYTH_189003440_pre_peritumor_5.0mm_std_resampled_mask.nii.gz
      - SYTH_189003440_pre_peritumor_7.0mm_std_resampled_mask.nii.gz
      - SYTH_189003440_post_volume.nii.gz
      - SYTH_189003440_post_std_resampled_volume.nii.gz
      - SYTH_189003440_post_mask.nii.gz
      - SYTH_189003440_post_std_resampled_mask.nii.gz
      - SYTH_189003440_post_peritumor_3.0mm_std_resampled_mask.nii.gz
      - SYTH_189003440_post_peritumor_5.0mm_std_resampled_mask.nii.gz
      - SYTH_189003440_post_peritumor_7.0mm_std_resampled_mask.nii.gz
  - TJ
  - XY
```

### [Additional] Combine Tumor and Peritumor Masks: Generate Merged ROI & Visualizations

The script `utils/combine_multimask.py` iterates through each phase, sequentially reading mask files matching `{site}_{pid}_{phase}_{mask_type}_mask.nii.gz`. It initializes an empty mask and populates foreground regions using the corresponding reindex values, saving the combined mask to the sample directory as `{site}_{pid}_{phase}_{infix}_mask.nii.gz`.

Generates a binary mask (union of all `mask_type` masks) with uniform foreground label `1`.

```sh
python utils/combine_multimask.py --root_dir root_dir/pCR_analysis --mask_type std_resampled peritumor_3.0mm_std_resampled peritumor_5.0mm_std_resampled peritumor_7.0mm_std_resampled --phase pre post --reindex 1 1 1 1 --infix comb_tumor_peritumor_std_resampled
```

Generates a multi-label mask (sequential overlay of `mask_type` masks) with indices `[1,2,3,4]`. Later masks overwrite earlier ones in overlapping regions.

```sh
python utils/combine_multimask.py --root_dir root_dir/pCR_analysis --mask_type std_resampled peritumor_3.0mm_std_resampled peritumor_5.0mm_std_resampled peritumor_7.0mm_std_resampled --phase pre post --reindex 1 2 3 4 --infix multi_tumor_peritumor_std_resampled
```

After processing, the directory structure is as follows:

```sh
root_dir
- pCR_analysis
  - SYTH
    - SYTH_189003440
      - SYTH_189003440_info.yaml
      - SYTH_189003440_pre_volume.nii.gz
      - SYTH_189003440_pre_std_resampled_volume.nii.gz
      - SYTH_189003440_pre_mask.nii.gz
      - SYTH_189003440_pre_std_resampled_mask.nii.gz
      - SYTH_189003440_pre_peritumor_3.0mm_std_resampled_mask.nii.gz
      - SYTH_189003440_pre_peritumor_5.0mm_std_resampled_mask.nii.gz
      - SYTH_189003440_pre_peritumor_7.0mm_std_resampled_mask.nii.gz
      - SYTH_189003440_pre_comb_tumor_peritumor_std_resampled_mask.nii.gz  # comb mask
      - SYTH_189003440_pre_multi_tumor_peritumor_std_resampled_mask.nii.gz  # multi mask
      - SYTH_189003440_post_volume.nii.gz
      - SYTH_189003440_post_std_resampled_volume.nii.gz
      - SYTH_189003440_post_mask.nii.gz
      - SYTH_189003440_post_std_resampled_mask.nii.gz
      - SYTH_189003440_post_peritumor_3.0mm_std_resampled_mask.nii.gz
      - SYTH_189003440_post_peritumor_5.0mm_std_resampled_mask.nii.gz
      - SYTH_189003440_post_peritumor_7.0mm_std_resampled_mask.nii.gz
      - SYTH_189003440_post_comb_tumor_peritumor_std_resampled_mask.nii.gz  # comb mask
      - SYTH_189003440_post_multi_tumor_peritumor_std_resampled_mask.nii.gz  # multi mask
  - TJ
  - XY
```

### 5️⃣Extract voxel-based radiomics for multi-regions: Run routine 04

Routine 04 extracts voxel-based radiomics features from pre- and post-therapy volume images using the PyRadiomics library. The radiomics extraction configuration is specified in the file `ESO-2025.10.31/pCR_analysis/radiomics_voxel_based_config.yaml`. This script needs to be executed multiple times to extract voxel-based radiomics features for the following regions: `[tumor, peritumor_3.0mm, peritumor_5.0mm, peritumor_7.0mm, tumor+peritumor_7.0mm]`.

For the Tumor Region:

```sh
python 04_extract_voxel_based_radiomics.py --root_dir root_dir/pCR_analysis --radiomics_config radiomics_voxel_based_config.yaml --volume_type std_resampled
--mask_type std_resampled
```

For Peritumor Regions:

```sh
python 04_extract_voxel_based_radiomics.py --root_dir root_dir/pCR_analysis --radiomics_config radiomics_voxel_based_config.yaml --volume_type std_resampled
--mask_type peritumor_3.0mm_std_resampled
python 04_extract_voxel_based_radiomics.py --root_dir root_dir/pCR_analysis --radiomics_config radiomics_voxel_based_config.yaml --volume_type std_resampled
--mask_type peritumor_5.0mm_std_resampled
python 04_extract_voxel_based_radiomics.py --root_dir root_dir/pCR_analysis --radiomics_config radiomics_voxel_based_config.yaml --volume_type std_resampled
--mask_type peritumor_7.0mm_std_resampled
```

For the Combined Tumor and Peritumor (7.0mm) Region:

```sh
python 04_extract_voxel_based_radiomics.py --root_dir root_dir/pCR_analysis --radiomics_config radiomics_voxel_based_config.yaml --volume_type std_resampled
--mask_type comb_tumor_peritumor_std_resampled
```

After processing, the directory structure is as follows:

```sh
root_dir
- pCR_analysis
  - SYTH
    - SYTH_189003440
      - SYTH_189003440_pre_std_resampled_volume_std_resampled_mask_voxel_radiomics
      - SYTH_189003440_pre_std_resampled_volume_peritumor_3.0mm_std_resampled_mask_voxel_radiomics
      - SYTH_189003440_pre_std_resampled_volume_peritumor_5.0mm_std_resampled_mask_voxel_radiomics
      - SYTH_189003440_pre_std_resampled_volume_peritumor_7.0mm_std_resampled_mask_voxel_radiomics
      - SYTH_189003440_pre_std_resampled_volume_comb_tumor_peritumor_std_resampled_mask_voxel_radiomics
      - SYTH_189003440_post_std_resampled_volume_std_resampled_mask_voxel_radiomics
      - SYTH_189003440_post_std_resampled_volume_peritumor_3.0mm_std_resampled_mask_voxel_radiomics
      - SYTH_189003440_post_std_resampled_volume_peritumor_5.0mm_std_resampled_mask_voxel_radiomics
      - SYTH_189003440_post_std_resampled_volume_peritumor_7.0mm_std_resampled_mask_voxel_radiomics
      - SYTH_189003440_post_std_resampled_volume_comb_tumor_peritumor_std_resampled_mask_voxel_radiomics
  - TJ
  - XY
```

### 6️⃣Fit K-Means clustering model based on voxel-based radiomics: Run routine 05

```sh
python 05_fit_k_means.py --root_dir root_dir/pCR_analysis --phase pre post --mask_type std_resampled --radiomics_type std_resampled_volume_std_resampled_mask --k_cluster 2 12 --iter 300 --output_model_dir root_dir/pCR_analysis/k_means_model_cuml --gpu {gpu-device-id} --select_prob 0.05 --random_seed 0
```

This script fits K-Means clustering models with the number of clusters `k` ranging from 2 to 12, with a maximum of 300 iteration rounds per model. Voxel-based radiomics features from both pre- and post-therapy images of each sample are used for model training.

These 19 voxel-based radiomics features are read from the directory `{site}_{pid}_{phase}_{radiomics_type}_voxel_radiomics`. For model fitting, all candidate voxels are restricted to the foreground region defined in the mask file `{site}_{pid}_{phase}_{mask_type}_mask.nii.gz`, from which `select_prob * 100%` ratio of random points are evaluated.

The K-Means model parameter files are saved to the following path: `output_model_dir/{mask_type}_mask_{radiomics_type}_voxel_radiomics/{k}_means_anchors.yaml`, where `k` ranges from 2 to 12.

The `--gpu` parameter is optional: omit it if you intend to use the CPU for computation, or specify a valid GPU device ID (e.g., `0` for the first GPU) if using GPU acceleration. When running on CPU, the script imports the `KMeans` class from `sklearn.cluster`; when running on GPU, it imports the corresponding class from `cuml.cluster`.

For the peritumor regions `[peritumor_3.0mm, peritumor_5.0mm, peritumor_7.0mm]`, use the following commands to fit K-Means models (with `k` ranging from 2 to 12) respectively:

```sh
python 05_fit_k_means.py --root_dir root_dir/pCR_analysis --phase pre post --mask_type peritumor_3.0mm_std_resampled --radiomics_type std_resampled_volume_peritumor_3.0mm_std_resampled_mask --k_cluster 2 12 --iter 300 --output_model_dir root_dir/pCR_analysis/k_means_model_cuml --gpu {gpu-device-id} --select_prob 0.05 --random_seed 0
python 05_fit_k_means.py --root_dir root_dir/pCR_analysis --phase pre post --mask_type peritumor_5.0mm_std_resampled --radiomics_type std_resampled_volume_peritumor_5.0mm_std_resampled_mask --k_cluster 2 12 --iter 300 --output_model_dir root_dir/pCR_analysis/k_means_model_cuml --gpu {gpu-device-id} --select_prob 0.05 --random_seed 0
python 05_fit_k_means.py --root_dir root_dir/pCR_analysis --phase pre post --mask_type peritumor_7.0mm_std_resampled --radiomics_type std_resampled_volume_peritumor_7.0mm_std_resampled_mask --k_cluster 2 12 --iter 300 --output_model_dir root_dir/pCR_analysis/k_means_model_cuml --gpu {gpu-device-id} --select_prob 0.05 --random_seed 0
```

For the combined `tumor+peritumor_7.0mm` region, use the following command:

```sh
python 05_fit_k_means.py --root_dir root_dir/pCR_analysis --phase pre post --mask_type comb_tumor_peritumor_std_resampled --radiomics_type std_resampled_volume_comb_tumor_peritumor_std_resampled_mask --k_cluster 2 12 --iter 300 --output_model_dir root_dir/pCR_analysis/k_means_model_cuml --gpu {gpu-device-id} --select_prob 0.05 --random_seed 0
```

The K-Means model parameter file `{k}_means_anchors.yaml` will record following attributes:

- `anchors`: List of length `k`, with each element extended as 19 dimensions representing radiomics feature vector anchor.
- `sse`: Sum of Squared Errors evaluated on all sampled points.
- `silhouette`: Silhouette Score evaluated on all sampled points.
- `ch`: Calinski-Harabasz Score evaluated on all sampled points.
- `db`: Davies-Bouldin Score evaluated on all sampled points.

After processing, the directory structure is as follows:

```sh
root_dir
- pCR_analysis
  - k_means_mdoel_cuml
    # model_dir: tumor 
    - std_resampled_mask_std_resampled_volume_std_resampled_mask_voxel_radiomics
      - 2_means_anchors.yaml
      - 3_means_anchors.yaml
      - ...
      - 12_means_anchors.yaml
    # model_dir: peritumor_3.0mm 
    - peritumor_3.0mm_std_resampled_mask_std_resampled_volume_peritumor_3.0mm_std_resampled_mask_voxel_radiomics
    # model_dir: peritumor_5.0mm 
    - peritumor_5.0mm_std_resampled_mask_std_resampled_volume_peritumor_3.0mm_std_resampled_mask_voxel_radiomics
    # model_dir: peritumor_7.0mm 
    - peritumor_7.0mm_std_resampled_mask_std_resampled_volume_peritumor_3.0mm_std_resampled_mask_voxel_radiomics
    # model_dir: tumor+peritumor_7.0mm 
    - comb_tumor_peritumor_std_resampled_mask_std_resampled_volume_comb_tumor_peritumor_std_resampled_mask_voxel_radiomics
```

### 7️⃣Plot K-Means model score graph: Run routine 06

For each `model_dir` generated in [Step 6️⃣](# 6️⃣Fit K-Means clustering model based on voxel-based radiomics: Run routine 05), you may execute Routine 06 to read all K-Means model parameter files named `{k}_means_anchors.yaml`, and generate line graphs to visualize the trending of the four model evaluation metrics: `[sse, silhouette, ch, db]`.

```sh
python 06_plot_model_score_graph.py --model_dir root_dir/pCR_analysis/k_means_model_cuml/{model_dir} --score sse silhouette ch db --output_graph_dir root_dir/pCR_analysis/k_means_graph_cuml/{model_dir}
```

After processing, the directory structure is as follows:

```sh
root_dir
- pCR_analysis
  - k_means_graph_cuml
    # model_dir: tumor 
    - std_resampled_mask_std_resampled_volume_std_resampled_mask_voxel_radiomics
      - graph_k_sse.jpg
      - graph_k_silhouette.jpg
      - graph_k_ch.jpg
      - graph_k_db.jpg
    # model_dir: peritumor_3.0mm 
    - peritumor_3.0mm_std_resampled_mask_std_resampled_volume_peritumor_3.0mm_std_resampled_mask_voxel_radiomics
    # model_dir: peritumor_5.0mm 
    - peritumor_5.0mm_std_resampled_mask_std_resampled_volume_peritumor_3.0mm_std_resampled_mask_voxel_radiomics
    # model_dir: peritumor_7.0mm 
    - peritumor_7.0mm_std_resampled_mask_std_resampled_volume_peritumor_3.0mm_std_resampled_mask_voxel_radiomics
    # model_dir: tumor+peritumor_7.0mm 
    - comb_tumor_peritumor_std_resampled_mask_std_resampled_volume_comb_tumor_peritumor_std_resampled_mask_voxel_radiomics
```

You may then manually select the optimal number of clusters `k` for each region by analyzing these `[sse, silhouette, ch, db]` trend graphs. Note the following evaluation criteria: the Elbow Rule is applicable for model selection based on the `sse` metric; higher values for the `silhouette` and `ch` metrics indicate better model performance, while lower values for the `db` metric indicate better model performance.

## 8️⃣Split habitat using selected K-Means model: Run routine 07

Routine 07 loads a pre-trained K-Means model and uses it to segment habitat regions for the foreground voxels of all samples. To specify the desired model, you need to provide the path to the model parameter file `{k}_means_anchors.yaml`. Additionally, you must specify the `phase`, `mask_type`, and `radiomics_type` parameters to configure which foreground mask and which set of radiomics features will be used for habitat segmentation.

```sh
python 07_split_habitat.py --model_parameter root_dir/pCR_analysis/k_means_model_cuml/{model_dir}/{k}_means_anchors.yaml --root_dir root_dir/pCR_analysis --phase pre post --mask_type {mask_type} --radiomics_type {radiomics_type} --small_region_thresh 4 --habitat_thresh 10
```

During habitat export, any habitat region will be removed if it meets either of the following criteria:

1. Its total voxel count is less than 10 (specified by `habitat_thresh`).
2. All of its connected components are smaller than 4 voxels (specified by `small_region_thresh`).

The available command-line options are as follows:

- `model_dir`: Refer to [Step 6️⃣](# 6️⃣Fit K-Means clustering model based on voxel-based radiomics: Run routine 05).
- `k`: Integer ranging from 2 to 12 (the number of clusters/habitat regions).
- `phase`: Any combination of `{pre, post}` (pre- and/or post-therapy phases).
- `mask_type`: Any combination of `{std_resampled, peritumor_3.0mm_std_resampled, peritumor_5.0mm_std_resampled, peritumor_7.0mm_std_resampled, comb_tumor_peritumor_std_resampled}`. Refer to [Step 5️⃣](# 5️⃣Extract voxel-based radiomics for multi-regions: Run routine 04).
- `radiomics_type`: Any combination of `{std_resampled_volume_std_resampled_mask, std_resampled_volume_peritumor_3.0mm_std_resampled_mask, std_resampled_volume_peritumor_5.0mm_std_resampled_mask, std_resampled_volume_peritumor_7.0mm_std_resampled_mask, std_resampled_volume_comb_tumor_peritumor_std_resampled_mask}`. Refer to [Step 6️⃣](# 6️⃣Fit K-Means clustering model based on voxel-based radiomics: Run routine 05).

This script exports habitat masks to the corresponding sample directories, with the output path formatted as `{site}_{pid}_{phase}_k={k}_{mask_type}_mask_{radiomics_type}_voxel_radiomics_habitat/{site}_{pid}_{phase}_k={k}_habitat_{habitat_index}.nii.gz`.

Here, `habitat_index` ranges from 1 to `k`, with each index corresponding to an individual habitat region. Additionally, a combined multi-label habitat mask is generated, in which `habitat_index` is set to `comb` — the label value of each habitat region within this multi-label mask corresponds to its respective `habitat_index`.

Below is an example for the tumor region:

Suppose you wish to use a K-Means model to segment `k=5` habitat regions for the pre- and post-therapy tumor regions of all samples. You should then configure the parameters as follows:

```sh
mode_dir=std_resampled_mask_std_resampled_volume_std_resampled_mask_voxel_radiomics
k=5
phase=[pre, post]
mask_type=std_resampled
radiomics_type=std_resampled_volume_std_resampled_mask
```

After processing, the directory structure is as follows:

```sh
root_dir
- pCR_analysis
  - SYTH
    - SYTH_189003440
      - SYTH_189003440_pre_k=5_std_resampled_mask_std_resampled_volume_std_resampled_mask_voxel_radiomics_habitat
        - SYTH_189003440_pre_k=5_habitat_1.nii.gz
        - SYTH_189003440_pre_k=5_habitat_2.nii.gz
        - SYTH_189003440_pre_k=5_habitat_3.nii.gz
        - SYTH_189003440_pre_k=5_habitat_4.nii.gz
        - SYTH_189003440_pre_k=5_habitat_5.nii.gz
        - SYTH_189003440_pre_k=5_habitat_comb.nii.gz
      - SYTH_189003440_post_k=5_std_resampled_mask_std_resampled_volume_std_resampled_mask_voxel_radiomics_habitat
        - SYTH_189003440_post_k=5_habitat_1.nii.gz
        - SYTH_189003440_post_k=5_habitat_2.nii.gz
        - SYTH_189003440_post_k=5_habitat_3.nii.gz
        - SYTH_189003440_post_k=5_habitat_4.nii.gz
        - SYTH_189003440_post_k=5_habitat_5.nii.gz
        - SYTH_189003440_post_k=5_habitat_comb.nii.gz
  - TJ
  - XY
```

## 9️⃣Extract radiomics for regions and habitats: Run routine 08

Routine 08 extracts and organizes radiomics features from medical imaging data, featuring configurable input parameters and structured Excel file outputs. It supports the following key parameters:

- Root directory (`-r/--root_dir`): The root path of the input medical imaging data.
- Time phases (`-p/--phase`): The pre- and/or post-therapy phases to process (default: `[pre, post]`).
- Image types (`-v/--volume_type`): The type of standardized volume images to use for feature extraction.
- Mask types (`-m/--mask_type`): The type of region masks (e.g., tumor, peritumor) to constrain feature extraction.
- Habitat types (`-h/--habitat_type`): The formatted habitat region type (in the format `k={k}_{infix}_habitat`, corresponding to clustered habitat regions).
- Radiomics configuration file (`-c/--radiomics_config`): The configuration file defining which radiomics features to extract.
- Output Excel directory (`-o/--output_excel_dir`): The directory to save the generated structured Excel workbooks.

This script traverses a hierarchical directory structure rooted at `root_dir`. This structure contains site-level directories, each of which holds sample directories named in the format `{site}_{pid}`. Each sample directory contains the required NIfTI volume images, NIfTI mask files, and habitat subdirectories (which store cluster-derived habitat mask files generated in previous steps).

The script automatically generates Excel workbooks for all valid combinations of the input parameters, following two rules:

1. One workbook is created for each `(phase, volume_type, mask_type)` parameter triplet.
2. Additional workbooks are created for each `(phase, volume_type, habitat_type, habitat_index)` parameter quadruplet (where `habitat_index` ranges from 1 to the `k` value specified in the `habitat_type` name).

The output paths of the Excel workbooks are formatted as follows:

- For the `(phase, volume_type, mask_type)` triplet: `{output_excel_dir}/{phase}-{volume_type}-{mask_type}.xlsx`
- For the `(phase, volume_type, habitat_type, habitat_index)` quadruplet: `{output_excel_dir}/{phase}-{volume_type}-{habitat_type}-{habitat_index}.xlsx`

For each parameter combination, the script executes the following steps in sequence:

1. Retrieve the corresponding NIfTI volume image: `{site}_{pid}_{phase}_{volume_type}_volume.nii.gz`.
2. Retrieve the corresponding mask file (either standard mask or habitat mask):
   - Standard mask: `{site}_{pid}_{phase}_{mask_type}_mask.nii.gz`
   - Habitat mask: `{habitat_type}_habitat/{site}_{pid}_{phase}_k={k}_habitat_{habitat_index}.nii.gz`
3. Extract radiomics features in accordance with the specifications in the provided `radiomics_config` file.
4. Record the extracted results into the target Excel workbook, which includes a unique sample identifier (`{site}_{pid}`) and dedicated columns for each extracted radiomics feature.

Below is an example for the tumor region and its `k=5` habitat regions:

Suppose you wish to extract radiomics features for the pre- and post-therapy tumor regions, as well as the `k=5` habitat regions segmented by the K-Means model, you should configure the parameters as follows:

```sh
mode_dir=std_resampled_mask_std_resampled_volume_std_resampled_mask_voxel_radiomics
k=5
phase=[pre, post]
volume_type=std_resampled
mask_type=std_resampled
habitat_type=k=5_std_resampled_mask_std_resampled_volume_std_resampled_mask_voxel_radiomics
```

```sh
python 08_extract_radiomics.py --root_dir root_dir --phase pre post --volume_type std_resampled --mask_type std_resampled --habitat_type k=5_std_resampled_mask_std_resampled_volume_std_resampled_mask_voxel_radiomics --radiomics_config radiomics_config.yaml 
--output_excel_dir root_dir/pCR_analysis/radiomics/tumor
```

After processing, the directory structure is as follows:

```sh
{output_excel_dir}
- {phase}-{volume_type}-{mask_type}.xlsx  # for each (phase, volume_type, mask_type)
- {phase}-{volume_type}-{habitat_type}-{habitat_index}.xlsx  # for each (phase, volume_type, habitat_type, habitat_index)
```

```sh
root_dir
- pCR_analysis
  - radiomics
    - tumor
      - pre-std_resampled-std_resampled.xlsx
      - pre-std_resampled-k=5_std_resampled_mask_std_resampled_volume_std_resampled_mask_voxel_radiomics-1.xlsx
      - pre-std_resampled-k=5_std_resampled_mask_std_resampled_volume_std_resampled_mask_voxel_radiomics-2.xlsx
      - pre-std_resampled-k=5_std_resampled_mask_std_resampled_volume_std_resampled_mask_voxel_radiomics-3.xlsx
      - pre-std_resampled-k=5_std_resampled_mask_std_resampled_volume_std_resampled_mask_voxel_radiomics-4.xlsx
      - pre-std_resampled-k=5_std_resampled_mask_std_resampled_volume_std_resampled_mask_voxel_radiomics-5.xlsx
      - post-std_resampled-std_resampled.xlsx
      - post-std_resampled-k=5_std_resampled_mask_std_resampled_volume_std_resampled_mask_voxel_radiomics-1.xlsx
      - post-std_resampled-k=5_std_resampled_mask_std_resampled_volume_std_resampled_mask_voxel_radiomics-2.xlsx
      - post-std_resampled-k=5_std_resampled_mask_std_resampled_volume_std_resampled_mask_voxel_radiomics-3.xlsx
      - post-std_resampled-k=5_std_resampled_mask_std_resampled_volume_std_resampled_mask_voxel_radiomics-4.xlsx
      - post-std_resampled-k=5_std_resampled_mask_std_resampled_volume_std_resampled_mask_voxel_radiomics-5.xlsx
```

## End

You may now utilize the radiomics Excel workbooks for downstream tasks, such as model fitting and evaluation.
