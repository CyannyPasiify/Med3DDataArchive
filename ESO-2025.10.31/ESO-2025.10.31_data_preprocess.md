# ESO-2025.10.31 Data Preprocess Tutorial

## Steps

### 1️⃣Download ESO-2025.10.31 data archive from [this link (Baidu Drive)](https://pan.baidu.com/s/12vgxqKR-QhsBbdMN-6WooA)

This is a private data archive. You may email the maintainer for password.

Place the `archive` into an empty `root_dir`, e.g., `root_dir=/path/to/ESO-2025.10.31 `.

### 2️⃣Scan ESO-2025.10.31 archive and manual check metadatas: Run routine 01

```sh
python 01_gen_archive_manifest.py --root_dir root_dir/archive --output_manifest_file root_dir/descriptor/archive_manifest.xlsx
```

Routine 01 first loads the data metadata files `archive/data_meta_{site}.xlsx` (where `site` takes values from the set `{tongji, shiyan-taihe, xiangyang}`). Then, it recursively scans all NIfTI files with the `.nii.gz` extension in the `root_dir/archive` directory, filters out valid 3D volume files and segmentation mask files, and finally generates a manifest file named `archive_manifest.xlsx` in the newly created `descriptor` subdirectory under `root_dir`.

All filtered NIfTI files are recorded in `archive_manifest.xlsx`. The file contains a single worksheet titled **Manifest**, which includes the following attributes:

- `file_path`: Relative path (with respect to `root_dir`) of the NIfTI `nii.gz` file.

- `site`: Clinical site where the examination was acquired.
- `phase`: The therapy phase, pre or post therapy.
- `pid`: Patient identifier.
- `type`: Content type of the file, with two possible values: `v3d` (3D volume) or `m3d` (3D mask).
- `szx`: Volume dimension size along the X-axis.
- `szy`: Volume dimension size along the Y-axis.
- `szz`: Volume dimension size along the Z-axis.
- `spx`: Voxel spacing along the X-axis (unit: mm).
- `spy`: Voxel spacing along the Y-axis (unit: mm).
- `spz`: Voxel spacing along the Z-axis (unit: mm).
- `orientation_from`: Orientation code for the start side, defined under the L-R (Left-Right) / P-A (Posterior-Anterior) / I-S (Inferior-Superior) coordinate system, may be oblique (e.g., `RPI`, `Oblique(closest to LPI)`).
- `orientation_to`: Orientation code for the end side, defined under the L-R / P-A / I-S coordinate system, may be oblique (e.g., `LAS`, `Oblique(closest to RAS)`).
- `dtype`: Data type of elements within the NIfTI file (e.g., `uint8`, `int16`, `int32`, `float64`).
- `transform`: 4×4 affine transformation matrix of the NIfTI file.
- `diff_trans_f_norm`: For entries sharing the same `seq` value, this metric represents the Frobenius norm (F-norm) of the differential affine transformation matrix between the volume (`v3d`) and mask (`m3d`) files, calculated as `m3d−v3d`. This value is recorded **exclusively for mask (`m3d`) files**. An F-norm of 0 indicates full spatial consistency between the corresponding volume and mask files.
- `*additional_attributes`: All other attributes copied from archive data meta files `archive/data_meta_tongji.xlsx`, `archive/data_meta_shiyan-taihe.xlsx` and `archive/data_meta_xiangyang.xlsx` (such as `Sex`, `Age`, `Chemotherapeutic Drugs`).

### 3️⃣Confirm and reorganize volume-mask pairs: Run routine 02

```sh
python 02_confirm_pairs.py --root_dir root_dir/archive --output_dir root_dir/grouped --archive_manifest root_dir/descriptor/archive_manifest.xlsx
```

Routine 02 loads the archive manifest file to retrieve dataset metadata. The script filters samples by each `pid` and `phase`, noting that each `pid` corresponds to exactly one pre-therapy sample and one post-therapy sample. It then recursively scans all NIfTI `.nii.gz` files in the `root_dir/archive` directory, filters the relevant files, and pairs each 3D volume file with its corresponding segmentation mask file to form valid sample pairs.

A dataset directory is created at `root_dir/grouped`, with three site subdirectories (`TJ`, `SYTH`, `XY`) established within it. Inside each site directory are subdirectories for the `pre` and `post` phases; within each phase subdirectory, an individual subdirectory is created for each sample, named in the format `{site}_{pid}_{phase}` (e.g., `SYTH_189003440_pre`) — this name also serves as the unique sample ID. Each sample directory contains the following files:

- `{ID}_info.yaml`: Sample information file containing core attributes (`pid`, `subset`).
- `{ID}_volume.nii.gz`: 3D volume file (data type: `float32`), saved following volume metadata correction.
- `{ID}_mask.nii.gz`: Multi-label segmentation mask file (data type: `uint8`), with metadata aligned to the corresponding volume file. This also functions as a binary foreground mask, as the ESO-2025.10.31 dataset contains only a single non-background label type.

After processing, the directory structure is as follows:

```sh
root_dir
- grouped
  - SYTH
    - pre
      - SYTH_189003440_pre
        - SYTH_189003440_pre_info.yaml
        - SYTH_189003440_pre_volume.nii.gz
        - SYTH_189003440_pre_mask.nii.gz
    - post
      - SYTH_189003440_post
        - SYTH_189003440_post_info.yaml
        - SYTH_189003440_post_volume.nii.gz
        - SYTH_189003440_post_mask.nii.gz
  - TJ
  - XY
```

### [Additional] Mask thresholding

```sh
python utils/mask_thresholding.py --root_dir root_dir/grouped --thresh -140.0 1000.0 --output_dir root_dir/grouped
```

This script recursively scans all sample directories in `root_dir/grouped` and processes medical image masks by thresholding against corresponding image values. Foreground mask pixels are set to background (0) if their matching image pixels fall outside the specified threshold range, effectively removing annotation errors in hollow regions and along mask edges. We observed that such annotation errors occur predominantly in the xiangyang (XY) site.

### 4️⃣Extract binary masks from multi-label mask files: Run routine 03

```sh
python 03_extract_binary_masks.py --root_dir root_dir/grouped --label_explanation root_dir/descriptor/label_map.yaml
```

Routine 03 recursively scans all NIfTI `{site}_{pid}_{phase}_mask.nii.gz` mask files in the `root_dir/grouped` directory, and splits each multi-label segmentation mask into a set of binary segmentation masks. The label values in the original masks are defined in `label_map.yaml` as follows: 

> Format: `{label_index}` = `{label_name}` (`short_form`)

- 0 = background (Bg)
- 1 = esophagus cancer ROI (EsoROI)

These binary masks are then saved in the same subdirectory as the original mask file, with the respective suffixes `{label_index:02d}_{label_name.short_form}` appended to the filenames.

After processing, the directory structure is as follows:

```sh
root_dir
- grouped
  - SYTH
    - pre
      - SYTH_189003440_pre
        - SYTH_189003440_pre_info.yaml
        - SYTH_189003440_pre_volume.nii.gz
        - SYTH_189003440_pre_mask.nii.gz
        - SYTH_189003440_pre_mask_00_Bg.nii.gz
        - SYTH_189003440_pre_mask_01_EsoROI.nii.gz
    - post
      - SYTH_189003440_post
        - SYTH_189003440_post_info.yaml
        - SYTH_189003440_post_volume.nii.gz
        - SYTH_189003440_post_mask.nii.gz
        - SYTH_189003440_post_mask_00_Bg.nii.gz
        - SYTH_189003440_post_mask_01_EsoROI.nii.gz
  - TJ
  - XY
```

### [Additional] Mask denoising and quality optimization

```sh
python utils/small_connected_region_detect.py --root_dir root_dir/grouped --region_volume_thresh 300.0 --output_manifest root_dir/descriptor/small_connected_region_300_manifest.xlsx
```

`utils/small_connected_region_detect.py` detects small connected regions in binary mask files and reports their centroid coordinates and corresponding physical volumes. Only regions with a physical volume below a predefined threshold are included in the output. Based on empirical settings, we adopt **300 mm³** as threshold to filter small 3D connected regions.

```sh
python utils/morphological_open_on_slice_small_region.py --root_dir root_dir/grouped --output_dir root_dir/grouped --kernel_size 2 2 --filter_halfedge 3 --region_area_thresh 10
```

`morphological_open_on_slice_small_region.py` performs connected component analysis, mask thresholding based on volumetric voxel values, and morphological closing operations (to remove isolated foreground regions and fill background holes) for the processing of small connected regions. The closing operations were executed slice-by-slice along the Z-axis. The complete correction steps are outlined as follows:

1. Do mask thresholding, only voxel value within `[-140, 1000]` can be labeled as foreground.
2. Set a small region area threshold of 10 mm², and generate small region masks for the foreground of each binary mask.
3. Perform morphological closing operations separately on each binary mask, using a 5×5 structural element.
4. Modifications were restricted to small regions only:
   - Multiply the background small region mask with the mask output from the closing operation;
   - Non-small regions remained unmodified.
5. Merge all processed binary masks into a single multi-label mask. For voxels with ambiguous labels (assigned to multiple indexes) or empty labels, we analyzed the 7×7 voxel neighborhood and selected the mode value as the candidate label.

Following this process, all small isolated regions within the foreground will be eliminated.

```sh
python utils/small_connected_region_detect.py --root_dir root_dir/grouped --region_volume_thresh 300.0 --output_manifest root_dir/descriptor/small_connected_region_300_after_modification_manifest.xlsx
```

You may re-run `utils/small_connected_region_detect.py` with a threshold of **100 mm³** to verify the mask state after denoising and quality optimization. This step is **optional**.

### 5️⃣Generate comprehensive manifest for dataset: Run routine 04

```sh
python 04_gen_dataset_manifest.py --root_dir root_dir/grouped --output_manifest_file root_dir/grouped/dataset_manifest.xlsx
```

Routine 04 recursively scans all NIfTI `nii.gz` files in the `root_dir/grouped` directory. For each sample in the subdirectories, it collates the corresponding volume file, multi-label mask file and individual binary mask files, then generates a manifest file named `dataset_manifest.xlsx` that indexes all files pertaining to each individual sample.

This routine raises an error if inconsistencies are detected in the **spatial size, affine transformation matrix, voxel spacing, or origin coordinates** across all NIfTI files for a single sample. An error is also raised if the data types of all mask NIfTI files associated with the same sample are mismatched.

Sample files for the ESO-2025.10.31 dataset is documented in manifest file `grouped/dataset_manifest.xlsx`. The manifest file contains a primary worksheet titled **Manifest**, with the following attributes included:

- `ID`: Sample identifier, formatted as `{site}_{pid}_{phase}` (e.g., `SYTH_1726441800_post`).

- `site`: Clinical site where the examination was acquired.

- `phase`: The therapy phase, pre or post therapy.

- `pid`: Patient identifier.

- `valid_labels`: All label indexes the mask contains.

- `info`: Sample information YAML file path relative to `root_dir`.

- `volume`: Volume NIfTI `nii.gz` file path relative to `root_dir`.

- `mask`: Multi-label mask NIfTI `nii.gz` file path relative to `root_dir`.

- `mask_{label_index}_{label_name}`: NIfTI `nii.gz` file path relative to `root_dir`, representing binary mask with `label_index` `label_name`.

- `mask_{label_index}_{label_name}_existence`: Existence status of the corresponding ROI. Value definition: `0` = no such ROI present in the mask, `1` = ROI present, `<empty>` = mask file is unavailable.

- `szx`: Volume size of X dimension for all NIfTI files associated with this sample.

- `szy`: Volume size of Y dimension for all NIfTI files associated with this sample.

- `szz`: Volume size of Z dimension for all NIfTI files associated with this sample.

- `spx`: Spacing (unit: mm) of X dimension for all NIfTI files associated with this sample.

- `spy`: Spacing (unit: mm) of Y dimension for all NIfTI files associated with this sample.

- `spz`: Spacing (unit: mm) of Z dimension for all NIfTI files associated with this sample.

- `orientation_from`: Orientation code for all NIfTI files associated with this sample from the start side, defined under the L-R (Left-Right) / P-A (Posterior-Anterior) / I-S (Inferior-Superior) coordinate system, may be oblique (e.g., `RAS`).

- `orientation_to`: Orientation code for all NIfTI files associated with this sample from the start side, defined under the L-R / P-A / I-S coordinate system, may be oblique (e.g., `LPI`).

- `vol_dtype`: Data type of the elements within the volume NIfTI file (e.g., `float32`).

  > Note: The data type of volumes is standardized to `float32` for all samples in `grouped`.

- `mask_dtype`: Data type of the elements within all mask NIfTI files associated with this sample (e.g., `uint8`).

  > Note: The data type of multi-label masks and binary masks is standardized to `uint8` for all samples in `grouped`.

- `transform`: Affine transformation matrix (4×4) for all NIfTI files associated with this sample.

- `*additional_attributes`: All other attributes copied from archive data meta files `archive/data_meta_tongji.xlsx`, `archive/data_meta_shiyan-taihe.xlsx` and `archive/data_meta_xiangyang.xlsx` (such as `Sex`, `Age`, `Chemotherapeutic Drugs`).

### 6️⃣Split dataset and derive worksheet in dataset manifest: Run routine 05

```sh
python 05_make_split.py --manifest_file root_dir/grouped/dataset_manifest.xlsx --split_name split01_TJ --site TJ --test_ratio 0.4 --val_ratio 0.2 --random_seed 0
```

First, this script can be used to generate a subset split for the internal center tongji (TJ). It appends the **split01_TJ** worksheet to the `grouped/dataset_manifest.xlsx` Excel manifest file, which stores the train/val/test split assignments for the TJ subset of the dataset. The script copies all attributes from the primary **Manifest** worksheet, appends a dedicated column (titled `split01_TJ`) for this split, and populates each entry with a `train`, `val`, or `test` label based on a random shuffle split (with a fixed random seed of 0). During the splitting process, pre- and post-therapy samples sharing the same `{site}_{pid}` are first grouped together. A two-stage split is then performed: first, the dataset is split into `train+val` and `test` sets at a ratio of 6:4; subsequently, the `train+val` subset is further split into `train` and `val` sets at a ratio of 8:2.

```sh
python 05_make_split.py --manifest_file root_dir/grouped/dataset_manifest.xlsx --split_name split02_SYTH --site SYTH --test_ratio 1.0 --val_ratio 0.0
```

For the external center shiyan-taihe (SYTH), all samples are allocated to the test set. This script appends the **split02_SYTH** worksheet to the `grouped/dataset_manifest.xlsx` Excel manifest file, which stores the split assignments for the SYTH dataset subset (consisting solely of the test set, denoted as External test set 1).

```sh
python 05_make_split.py --manifest_file root_dir/grouped/dataset_manifest.xlsx --split_name split03_XY --site XY --test_ratio 1.0 --val_ratio 0.0
```

For the external center xiangyang (XY), all samples are allocated to the test set. This script appends the **split03_XY** worksheet to the `grouped/dataset_manifest.xlsx` Excel manifest file, which stores the split assignments for the XY dataset subset (consisting solely of the test set, denoted as External test set 2).

### 7️⃣Extracts subset-specific index manifests from dataset manifest: Run routine 06

Given a split-specific worksheet within the dataset manifest file, Routine 06 extracts subset-specific index manifests based on the split labels (e.g., train, val, test). Index manifests for individual subsets (train, val, test) or combined subsets (e.g., train+val) can be generated as separate Excel files; for instance, the train index manifest contains only entries labeled as `train` in the target split worksheet.

Prior to running routine 06, ensure the desired split is included as a dedicated worksheet in the dataset manifest file. For example, if `root_dir/grouped/dataset_manifest.xlsx` contains the worksheet `split01_TJ`, you may specify the option `--split_name split01_TJ` when executing routine 06 to generate the corresponding subset-specific index manifests.

The following routine generates index manifests for the split `split01_TJ`. Manifest files `split01_TJ_train_val.xlsx`, `split01_TJ_train.xlsx`, `split01_TJ_val.xlsx` and `split01_TJ_test.xlsx` are generated in the directory `root_dir/grouped/splits/split01_TJ`.

```sh
python 06_extract_split_index_manifest.py --manifest_file root_dir/grouped/dataset_manifest.xlsx --split_name split01_TJ --output_index_manifest_dir root_dir/grouped/splits/split01_TJ --subsets train val --subsets train --subsets val --subsets test
```

For `split02_SYTH` and `split03_XY`, the following routine generates the index manifest files `split02_SYTH_test.xlsx` and `split03_XY_test.xlsx` in the directories `root_dir/grouped/splits/split02_SYTH` and `root_dir/grouped/splits/split03_XY`, respectively.

```sh
python 06_extract_split_index_manifest.py --manifest_file root_dir/grouped/dataset_manifest.xlsx --split_name split02_SYTH --output_index_manifest_dir root_dir/grouped/splits/split02_SYTH --subsets test
python 06_extract_split_index_manifest.py --manifest_file root_dir/grouped/dataset_manifest.xlsx --split_name split03_XY --output_index_manifest_dir root_dir/grouped/splits/split03_XY --subsets test
```

After processing, the directory structure is as follows:

```sh
root_dir
- grouped
  - splits
    - split01_TJ
      - split01_TJ_train_val.xlsx
      - split01_TJ_train.xlsx
      - split01_TJ_val.xlsx
      - split01_TJ_test.xlsx
    - split02_SYTH
      - split02_SYTH_test.xlsx
    - split03_XY
      - split03_XY_test.xlsx
```

You may modify the `--subsets` option by adding, removing, or revising subset values to control the generation of subset-specific index manifests. Note that specifying a subset (e.g., `--subsets val`) for which no corresponding `val` label exists in the target split worksheet will result in an overall failure, where all extraction tasks are aborted. You may refer to error messages for more information.

## End

You may now utilize the data files, dataset manifest, and subset-specific index manifests located in `root_dir/grouped` for downstream tasks, such as neural network training and model evaluation.
